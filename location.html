<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF 勤怠打刻アプリ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p#status {
            font-size: 1em;
            color: #555;
            min-height: 20px; /* レイアウト崩れ防止 */
        }
        .button-group {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        button {
            background-color: #00b900; /* LINE Green */
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            width: 100%;
        }
        button:hover {
            background-color: #00a000;
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        #location-data {
            margin-top: 25px;
            font-size: 0.9em;
            color: #666;
            text-align: left;
            word-break: break-all;
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .fallback-message { /* JSONPでは不要だが、念のため残す */
            background-color: #fff9db;
            border-left: 4px solid #ffd43b;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            text-align: left;
        }
        .fallback-button {
            background-color: #339af0;
            margin-top: 10px;
        }
        .retry-button {
            background-color: #ff6b6b;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>勤怠打刻アプリ</h1>
        <p id="status">LIFFの初期化中...</p>
        <div class="button-group">
            <button id="clockInButton" disabled>出勤する</button>
            <button id="clockOutButton" disabled>退勤する</button>
        </div>
        <div id="location-data">
            <p><strong>打刻ログ:</strong></p>
            <p id="last-punch-info">最新の打刻はありません。</p>
        </div>
        <div id="fallback-message" class="fallback-message" style="display: none;">
            <p>LIFF機能の読み込みに失敗しました。以下の方法をお試しください:</p>
            <button id="openInBrowser" class="fallback-button">外部ブラウザで開く</button>
            <button id="retryButton" class="retry-button">再読み込み</button>
        </div>
    </div>

    <script>
        const LIFF_ID = "2007570655-EXXROdzZ"; 
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwWGn6WVkv0DUMXNnERFO0Lz-YyWLasOXerntZEWveot3DCSlN0oskjTFwZNj8ff7AQcg/exec"; // ★JSONP用のGAS URL

        const statusDisplay = document.getElementById('status');
        const clockInButton = document.getElementById('clockInButton');
        const clockOutButton = document.getElementById('clockOutButton');
        const lastPunchInfo = document.getElementById('last-punch-info');
        const fallbackMessage = document.getElementById('fallback-message'); // フォールバックメッセージエリア
        const openInBrowserButton = document.getElementById('openInBrowser');
        const retryButton = document.getElementById('retryButton');


        let userProfile = null;

        /**
         * LIFF初期化とユーザー情報の取得
         */
        window.onload = async () => {
            try {
                // liffオブジェクトが定義されているか最終チェック
                if (typeof liff === 'undefined') {
                    console.error("LIFF SDK: liff object is undefined. SDK did not load correctly.");
                    statusDisplay.textContent = "LIFF SDKの読み込みに失敗しました。ネットワーク接続を確認してください。";
                    fallbackMessage.style.display = 'block'; // エラー表示
                    return;
                }

                await liff.init({ liffId: LIFF_ID });
                statusDisplay.textContent = 'LIFF初期化完了！';
                fallbackMessage.style.display = 'none'; // 成功したらエラーメッセージを非表示


                if (!liff.isLoggedIn()) {
                    statusDisplay.textContent = 'LINEにログインしていません。ログインが必要です。';
                    liff.login(); 
                } else {
                    userProfile = await liff.getProfile();
                    statusDisplay.textContent = `こんにちは、${userProfile.displayName}さん！`;
                    clockInButton.disabled = false;
                    clockOutButton.disabled = false;
                }
            } catch (err) {
                console.error("LIFF初期化エラー:", err);
                statusDisplay.textContent = `LIFF初期化に失敗しました: ${err.message || '不明なエラー'}`;
                fallbackMessage.style.display = 'block'; // エラー表示
                alert("LIFF初期化エラー:\n" + (err.message || '不明なエラーが発生しました。') + "\n詳細をコンソールで確認してください。");
            }
        };

        /**
         * 外部ブラウザで開く
         */
        function openInExternalBrowser() {
            const currentUrl = window.location.href;
            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.openWindow({
                    url: currentUrl,
                    external: true 
                });
            } else {
                window.open(`https://liff.line.me/${LIFF_ID}?redirectUri=${encodeURIComponent(currentUrl)}`, '_blank');
            }
        }

        /**
         * GPS取得 (Promiseラッパー)
         */
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }

        /**
         * JSONP方式でGASへ送信
         */
        function sendToGAS_JSONP(userId, type, latitude, longitude) {
            return new Promise((resolve, reject) => {
                const timestamp = new Date().toISOString();
                const callbackName = 'jsonpCallback_' + Date.now(); // ユニークなコールバック名

                // グローバルなコールバック関数を定義
                window[callbackName] = function (response) {
                    delete window[callbackName]; // 一度実行したら削除
                    script.remove(); // スクリプトタグも削除

                    if (response?.status === 'success') {
                        resolve(response);
                    } else {
                        reject(new Error(response?.message || 'GASからの応答エラー'));
                    }
                };

                // パラメータをURLSearchParamsで構築
                const params = new URLSearchParams({
                    userId: userId,
                    type: type,
                    latitude: latitude,
                    longitude: longitude,
                    timestamp: timestamp,
                    callback: callbackName // コールバック名をパラメータに含める
                });

                // スクリプトタグを生成してリクエストを送信
                const script = document.createElement('script');
                script.src = `${GAS_WEB_APP_URL}?${params.toString()}`;
                script.onerror = () => {
                    delete window[callbackName];
                    script.remove();
                    reject(new Error('GASスクリプトの読み込み（通信）に失敗しました。'));
                };

                document.head.appendChild(script); // headにスクリプトを追加して実行
            });
        }

        /**
         * 出勤・退勤ボタン押下時の共通処理
         */
        async function punch(type) {
            if (!userProfile) {
                statusDisplay.textContent = 'ユーザー情報が取得できません。';
                alert('LINE連携が完了していません。再度LIFFアプリを開き直してください。');
                return;
            }

            statusDisplay.textContent = `位置情報取得中... (${type === 'clockIn' ? '出勤' : '退勤'})`;
            clockInButton.disabled = true;
            clockOutButton.disabled = true;

            try {
                // GPS取得
                const pos = await getCurrentPosition();
                statusDisplay.textContent = '打刻送信中...';

                // JSONP方式でGASへ送信
                const gasResponse = await sendToGAS_JSONP(userProfile.userId, type, pos.coords.latitude, pos.coords.longitude);
                
                statusDisplay.textContent = `✅ ${type === 'clockIn' ? '出勤' : '退勤'}打刻完了！`;
                lastPunchInfo.innerHTML = `最終打刻: ${new Date().toLocaleString()}<br>種別: ${type === 'clockIn' ? '出勤' : '退勤'}<br>緯度: ${pos.coords.latitude.toFixed(6)}, 経度: ${pos.coords.longitude.toFixed(6)}`;

            } catch (err) {
                console.error('打刻エラー:', err);
                statusDisplay.textContent = `❌ エラー: ${err.message}`;
                alert(`打刻エラー:\n${err.message}`);
            } finally {
                clockInButton.disabled = false;
                clockOutButton.disabled = false;
            }
        }

        // イベントリスナー設定
        clockInButton.addEventListener('click', () => punch('clockIn'));
        clockOutButton.addEventListener('click', () => punch('clockOut'));
        openInBrowserButton.addEventListener('click', openInExternalBrowser);
        retryButton.addEventListener('click', () => window.location.reload());
    </script>
</body>
</html>
