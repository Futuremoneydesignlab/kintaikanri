<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>勤怠打刻</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>出勤・退勤打刻</h2>
  <p id="userName">ログイン確認中...</p>
  <button onclick="clockIn()">出勤</button>
  <button onclick="clockOut()">退勤</button>
  <p id="status"></p>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxeJwOX7dBDBxBD2qOkNd9XktldBhB1kkfddh31E1T3G_z_gV67TpO4nCI4PFl3VB2bYA/exec';

    let userId = null;

    // LIFF初期化とログイン処理
    window.onload = async () => {
      try {
        await liff.init({ liffId: '2007570655-EXXROdzZ' });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        userId = profile.userId;
        document.getElementById('userName').textContent = `ようこそ ${profile.displayName} さん`;

      } catch (err) {
        document.getElementById('userName').textContent = `❌ LIFFエラー: ${err.message}`;
        console.error(err);
      }
    };

    // 出勤・退勤ボタン押下時の共通処理
    async function punch(type) {
      const statusEl = document.getElementById('status');
      if (!userId) {
        statusEl.textContent = 'ユーザー情報取得失敗';
        return;
      }

      try {
        statusEl.textContent = '位置情報取得中...';
        const pos = await getCurrentPosition();
        statusEl.textContent = '打刻送信中...';

        await sendToGAS(userId, type, pos.coords.latitude, pos.coords.longitude);
        statusEl.textContent = `✅ ${type === 'clockIn' ? '出勤' : '退勤'}打刻完了！`;
      } catch (err) {
        console.error('打刻エラー:', err);
        statusEl.textContent = `❌ エラー: ${err.message}`;
      }
    }

    function clockIn() { punch('clockIn'); }
    function clockOut() { punch('clockOut'); }

    // JSONP送信
    function sendToGAS(userId, type, latitude, longitude) {
      return new Promise((resolve, reject) => {
        const timestamp = new Date().toISOString();
        const callbackName = 'jsonpCallback_' + Date.now();

        window[callbackName] = function (response) {
          delete window[callbackName];
          script.remove();
          if (response?.status === 'success') {
            resolve(response);
          } else {
            reject(new Error(response?.message || '不明なエラー'));
          }
        };

        const params = new URLSearchParams({
          userId, type, latitude, longitude, timestamp,
          callback: callbackName
        });

        const script = document.createElement('script');
        script.src = `${GAS_URL}?${params.toString()}`;
        script.onerror = () => {
          delete window[callbackName];
          script.remove();
          reject(new Error('スクリプト読み込み失敗'));
        };

        document.head.appendChild(script);
      });
    }

    // GPS取得
    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        });
      });
    }
  </script>
</body>
</html>
